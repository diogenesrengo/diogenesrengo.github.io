<!DOCTYPE html>
<html>
<head>
    <style>
        canvas {
            display: block;
            border:2px solid green;
            background-color: black;
        }
        #notice_box {
            position: absolute;
            width: 300px;
            height: 25px;
            border-radius: 4px;
            left: 490px;
            top: 565px;
            /* background-color: #ffff33; */
            background-color: black;
            visibility: hidden;
            opacity: 0.7;
        }
        #notice {
            position: absolute;
            left: 5px;
            top: 4px;
            color: white;
            font: bold 12px Tahoma, serif;
        }
    </style>
</head>
<body>
    <div style="position: relative;">
        <div id="notice_box">
            <div id="notice">
                <span id="span1"></span><span id="span2"></span>
            </div>
        </div>
        <canvas id="fireworksCanvas" width="800" height="600"></canvas>
    </div>

    <script>
    /* classes Particle and Firework with some modifications from
       https://github.com/The-Best-Codes/the-best-codes.github.io */

    const canvas = document.getElementById("fireworksCanvas");
    const c = canvas.getContext("2d");

    class Particle {
        constructor(x, y, color, velocity) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.radius = Math.random() * 2 + 1;
            this.velocity = velocity;
            this.life = 100;
            this.alpha = 1;
            this.shimmer = Math.random() < 0.3;
        }
        draw() {
            c.beginPath();
            c.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            let alpha = this.alpha;
            if (this.shimmer) { alpha *= 0.5 + Math.random() * 0.5; }
            c.fillStyle = 
                `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${alpha})`;
            c.fill();
        }
        update() {
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.velocity.y += 0.05;
            this.life--;
            this.alpha -= 0.01;
        }
    }

    class Firework {
        constructor(x, y, color, speed, parts) {
            this.x = x;
            this.y = canvas.height;
            this.targetX = x;
            this.targetY = y;
            this.color = (color)? color : {
                r: Math.floor(Math.random() * 255),
                g: Math.floor(Math.random() * 255),
                b: Math.floor(Math.random() * 255),
            };
            const angle = (Math.random() * Math.PI) / 4 - Math.PI / 8;
            this.speed = (Math.random() * 3 + 5) * ((speed)? speed : 1); //default: 5-8
            this.velocity = { 
                x: Math.sin(angle) * this.speed,
                y: -Math.cos(angle) * this.speed,
            };
            this.particles = [];
            this.trail = [];
            this.exploded = false;
            this.explosionProgress = 0;
            this.hasShimmer = Math.random() < 0.5;
            this.parts = parts;
        }
        explode() {
            let n = (15 + Math.random() * 50) * ((this.parts)? this.parts : 1);
            for (let i = 0; i < n; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 1;
                const velocity = 
                    { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed, };
                this.particles.push( 
                    new Particle(this.x, this.y, this.color, velocity)
                );
            }
            this.exploded = true;
        }
        update() {
            if (!this.exploded) {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                //here
                this.velocity.y += 0.02; //0.05;
                //
                this.trail.push( 
                    new Particle(this.x, this.y, this.color, {x:0, y:0})
                );
                if (this.trail.length > 20) this.trail.shift();
                if (this.velocity.y >= 0 || this.y <= this.targetY) this.explode();
            } else {
                this.explosionProgress += 0.02;
                this.particles.forEach( 
                    (particle) => {particle.update(); particle.draw();}
                );
                this.particles = 
                    this.particles.filter( (particle) => particle.life > 0);
            }
            this.trail.forEach( (particle, index) => {
                particle.alpha = 
                    (index / this.trail.length) * (1 - this.explosionProgress);
                if (this.hasShimmer) { particle.shimmer = true; }
                particle.draw();
            });
        }
        draw() {
            if (!this.exploded) {
                c.beginPath();
                c.arc(this.x, this.y, 2, 0, Math.PI * 2);
                c.fillStyle = 
                    `rgb(${this.color.r}, ${this.color.g}, ${this.color.b})`;
                c.fill();
            }
        }
    }

    class App {
        constructor(username, tokens, color) {
            this.settings = {
                color: 1,
                speed: 1,
                parts: 1,
                fired: 0.1,
                tperfw: 1,
                max_fw: 50,
                notice: true,
            };
            this.events = {
                tip: {
                    username: username,
                    tokens: tokens,
                    colorGroup: this.color2rgb(color),
                },
                start: true,
            };
            this.fireworks = [];
            this.total = Math.round(this.events.tip.tokens / this.settings.tperfw);
        }
        color2rgb(str) {
            switch (str) {
                // $settings.color
                case "red":    return {r:255, g:  0, b:  0};
                case "orange": return {r:255, g:135, b:  0};
                case "pink":   return {r:255, g:  0, b:144};
                case "gold":   return {r:255, g:211, b:  0};
                case "yellow": return {r:255, g:255, b:  0};
                case "green":  return {r:161, g:255, b: 10};
                case "cyan":   return {r: 10, g:239, b:255};
                case "blue":   return {r: 20, g:125, b:245};
                case "purple": return {r:190, g: 10, b:255};
                case "white":  return {r:255, g:255, b:255};
                case "black":  return {r:  0, g:  0, b:  0};
                // $user.colorGroup
                case "o":      // owner
                case "m":      // moderator
                case "f":      // fanclub member
                               return {r:255, g:  0, b:  0}; // red
                case "l":      return {r: 48, g: 25, b: 52}; // dark purple
                case "p":      return {r:177, g:156, b:217}; // light purple
                case "tr":     return {r:  0, g:  0, b:139}; // dark blue
                case "t":      return {r:173, g:216, b:230}; // light blue
                case "g":      return {r:128, g:128, b:128}; // grey
                //    
                default: return undefined;
            }
        }
        speed2num(str) {
            switch (str) {
                // $settings.speed
                case "slow":       return 0.5;
                case "fast":       return 2;
                default: return 1;
            }
        }
        parts2num(str) {
            switch (str) {
                // $settings.parts
                case "few":     return 0.5;
                case "much":    return 5;
                case "huge":    return 10;
                case "atomic":  return 50;
                default: return 1;
            }
        }
        fired2num(str) {
            switch (str) {
                // $settings.fired
                case "slow": return 0.01;
                case "fast": return 1;
                default: return 0.1;
            }
        }
        get_settings(color, speed, parts, fired, tperfw, max_fw, notice) {
            this.settings = {
                color: this.color2rgb(color),
                speed: this.speed2num(speed),
                parts: this.parts2num(parts),
                fired: this.fired2num(fired),
                tperfw: tperfw,
                max_fw: max_fw,
                notice: notice
            };
        }
    }

    function animate_fireworks(fireworks, total, settings) {
        console.log("fireworks="+fireworks);
        c.clearRect(0, 0, canvas.width, canvas.height);
        fireworks.forEach( (firework) => {firework.update(); firework.draw();} );
        if (total > 0 && Math.random() < settings.fired) {
            console.log("settings.fired="+settings.fired);
            const x = Math.random() * canvas.width;
            const y = (Math.random() * canvas.height) / 2;
            fireworks.push(
              new Firework(x, y, settings.color, settings.speed, settings.parts)
            );
            total--;
        }
        fireworks = fireworks.filter(
            (firework) => !firework.exploded || firework.particles.length > 0
        );
        if (total > 0 || fireworks.length)
            requestAnimationFrame(animate_fireworks);
    }
    
    function show_notice(enable, delay) {
      if (enable) {
        elem = document.getElementById("notice_box");
        elem.style.visibility = "visible"; 
        setTimeout(() => elem.style.visibility = "hidden", delay);
      }
    }
    
    function notice_tip(tip) {
        let elem = document.getElementById("span1");
        elem.style.color = 
          `rgb(${tip.colorGroup.r}, ${tip.colorGroup.g}, ${tip.colorGroup.b})`;
        elem.innerHTML = tip.username;
        document.getElementById("span2").innerHTML = 
          " tipped " + tip.tokens + ((tip.tokens == 1)? " token" : " tokens");
    }

    function notice_start() {
        let elem = document.getElementById("span1");
        elem.style.color = "white";
        elem.innerHTML = "Fireworks For Tokens!";
    }

    let app = new App("rengo250", 5, "l");
    app.get_settings("", "", "", "", 1, 50, true);
    
    notice_start();
    show_notice(true, 2000);
    animate_fireworks(app.fireworks, app.total, app.settings);

    //notice_tipped(app.events.tip);
    //show_notice(app.settings.notice, 3000);
    //animate_fireworks(app.fireworks, app.total, app.settings);

    </script>
  </body>
</html>
