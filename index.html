<!DOCTYPE html>
<html>
<head>
    <style>
        canvas {
            display: block;
            /*border:2px solid black;*/
            background-color: black;
        }
        #notice_box {
            position: absolute;
            width: 300px;
            height: 20px;
            border-radius: 4px;
            left: 490px;
            top: 570px;
            /* background-color: #ffff33; */
            background-color: black;
            visibility: hidden;
            opacity: 0.7;
        }
        #notice {
            position: absolute;
            left: 5px;
            top: 3px;
            color: white;
            font: bold 11px Tahoma, serif;
        }
    </style>
</head>
<body>
    <div style="position: relative;">
        <div id="notice_box">
            <div id="notice">
                <span id="span1"></span><span id="span2"></span>
            </div>
        </div>
        <canvas id="fireworksCanvas" width="800" height="600"></canvas>
    </div>

    <script>

    const canvas = document.getElementById("fireworksCanvas");
    const c = canvas.getContext("2d");
    
    function color_pick(color, alpha) {
        let rgb = {
            red:    "255,   0,   0,",
            orange: "255, 135,   0,",
            pink:   "255,   0, 144,",
            gold:   "255, 211,   0,",
            yellow: "255, 255,   0,",
            green:  "161, 255,  10,",
            cyan:   " 10, 239, 255,",
            blue:   " 20, 125, 245,",
            purple: "190,  10, 255,",
            white:  "255, 255, 255,", //9
            black:  "  0,   0,   0,",
            //$user.colorGroup
            o:      "255,   0,   0,", //red owner
            m:      "255,   0,   0,", //    moderator
            f:      "255,   0,   0,", //    fanclub member
            l:      " 48,  25,  52,", //dark purple
            p:      "177, 156, 217,", //light purple
            tr:     "  0,   0, 139,", //dark blue
            t:      "173, 216, 230,", //light blue
            g:      "128, 128, 128,", //grey
        };
        let names = Object.keys(rgb);
        console.log(names);
        if (!color) color = names[ Math.random() * 9 << 0 ];
        console.log( `rgba(${rgb[color]} ${alpha})` );
        if (alpha) 
            return `rgba(${rgb[color]} ${alpha})`;
        return `rgb(${rgb[color]})`;
    }

    class Particle {
        constructor(x, y, color, velocity, radius) {
            this.x = x;
            this.y = y;
            this.color = (color)? color : color_pick();
            //this.radius = Math.random() * 2 + 1;
            this.radius = Math.random() * 2 + ((radius)? radius : 0.75);
            this.velocity = velocity;
            this.life = 100;
            this.alpha = 1;
            this.shimmer = Math.random() < 0.3;
        }
        draw() {
            c.beginPath();
            c.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            let alpha = this.alpha;
            if (this.shimmer) { alpha *= 0.5 + Math.random() * 0.5; }
            c.fillStyle = color_pick(this.color, alpha); 
            c.fill();
        }
        update() {
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.velocity.y += 0.05;
            this.life--;
            this.alpha -= 0.02; //0.01;
        }
    }

    class Firework {
        constructor(x, y, color, speed, parts, radius, multic) {
            this.x = x;
            this.y = canvas.height;
            this.targetX = x;
            this.targetY = y;
            this.color = (color)? color : color_pick();
            const angle = (Math.random() * Math.PI) / 4 - Math.PI / 8;
            this.speed = (Math.random() * 3 + 5) * ((speed)? speed : 1); //default: 5-8
            this.velocity = { 
                x: Math.sin(angle) * this.speed,
                y: -Math.cos(angle) * this.speed,
            };
            this.particles = [];
            this.trail = [];
            this.exploded = false;
            this.explosionProgress = 0;
            this.hasShimmer = Math.random() < 0.5;
            this.parts = parts;
            this.partsMulticolor = multic;
            this.radius = radius;
        }
        explode() {
            let n = (15 + Math.random() * 50) * ((this.parts)? this.parts : 1);
            for (let i = 0; i < n; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 1;
                const velocity = 
                    { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed, };
                this.particles.push( 
                    new Particle(
                        this.x,
                        this.y, 
                        (this.partsMulticolor)? 0 : this.color,
                        velocity,
                        this.radius
                    )
                );
            }
            this.exploded = true;
        }
        update() {
            if (!this.exploded) {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.velocity.y += 0.05;
                this.trail.push( 
                    new Particle(this.x, this.y, this.color, {x:0, y:0}, this.radius)
                );
                if (this.trail.length > 20) this.trail.shift();
                if (this.velocity.y >= 0 || this.y <= this.targetY) this.explode();
            } else {
                this.explosionProgress += 0.02;
                this.particles.forEach( 
                    (particle) => {particle.update(); particle.draw();}
                );
                this.particles = 
                    this.particles.filter( (particle) => particle.life > 0);
            }
            this.trail.forEach( (particle, index) => {
                particle.alpha = 
                    (index / this.trail.length) * (1 - this.explosionProgress);
                if (this.hasShimmer) { particle.shimmer = true; }
                particle.draw();
            });
        }
        draw() {
            if (!this.exploded) {
                c.beginPath();
                c.arc(this.x, this.y, 2, 0, Math.PI * 2);
                c.fillStyle = color_pick(this.color);
                c.fill();
            }
        }
    }

    class App {
        constructor() {
            this.settings = {};
            this.fireworks = {
                data: [],
                total: 0,
                fired: 1,
            }
        }
        speed2num(str) {
            switch (str) {
                case "slow":    return 0.5;
                case "fast":    return 2;
                default: return 1;
            }
        }
        parts2num(str) {
            switch (str) {
                case "few":     return 0.5;
                case "much":    return 5;
                case "huge":    return 10;
                case "atomic":  return 50;
                default: return 1;
            }
        }
        fired2num(str) {
            switch (str) {
                case "separate": return 0.01;
                case "together": return 1;
                default: return 0.1;
            }
        }
        radius2num(str) {
            switch (str) {
                case "small":   return 0.5;
                case "big":     return 1.1;
                default: return 0.75;
            }
        }
        get_settings() {
            this.settings = $settings;
            this.fireworks.fired = this.fired2num( $settings.fired );
        }
        set_fireworks_total(tokens) {
            this.fireworks.total = Math.round(tokens / this.settings.tperfw);
            if (this.fireworks.total >= this.settings.max_fw)
                this.fireworks.total = this.settings.max_fw;
        }
        
        animate_fireworks() {
            c.clearRect(0, 0, canvas.width, canvas.height);
            this.fireworks.data.forEach(
                (firework) => { firework.update(); firework.draw(); }
            );
            if (this.fireworks.total > 0 && Math.random() < this.fireworks.fired) {
                this.fireworks.data.push( 
                    new Firework(
                        Math.random() * canvas.width,
                        (Math.random() * canvas.height) / 2,
                        this.settings.color,
                        this.speed2num( this.settings.speed ),
                        this.parts2num( this.settings.parts ),
                        this.radius2num( this.settings.radius ),
                        this.settings.multic,
                    )
                );
                this.fireworks.total--;
            }
            this.fireworks.data = this.fireworks.data.filter( (firework) => 
                !firework.exploded || firework.particles.length > 0
            );
            if (this.fireworks.total > 0 || this.fireworks.data.length)
                requestAnimationFrame(() => this.animate_fireworks());
        }
    
        show_notice(delay) {
            if (this.settings.notice) {
                let elem = document.getElementById("notice_box");
                elem.style.visibility = "visible"; 
                setTimeout(() => elem.style.visibility = "hidden", delay);
            }
        }
        notice_tip(tip, delay) {
            let elem = document.getElementById("span1");
            elem.style.color = color_pick(tip.colorGroup);
            elem.innerHTML = tip.username;
            document.getElementById("span2").innerHTML = 
        " tipped " + tip.tokens + ((tip.tokens == 1)? " token" : " tokens");
            this.show_notice(delay);
        }
        notice_start(delay) {
            let elem = document.getElementById("span1");
            elem.style.color = "white";
            elem.innerHTML = "Starting Fireworks For Tokens!";
            this.show_notice(delay);
        }
    }


    $settings = {
         color:  "purple",
         speed:  "normal",
         parts:  "huge",
         radius: "medium",
         fired:  "together",
         tperfw: 1,
         max_fw: 25,
         notice: true,
         multic: true,
    };
            
    $events_data = {
        tip: {
            username: "rengo250",
            tokens: 2,
            colorGroup: "l",
        },
        start: true,
    };

    const app = new App();
    
    app.get_settings();
    
    app.notice_start(3000);
    app.set_fireworks_total(1);
    app.animate_fireworks();

    app.settings.multic = false;
    setTimeout(() => {
        app.notice_tip($events_data.tip, 3000);
        app.set_fireworks_total( $events_data.tip.tokens );
        app.animate_fireworks();
    }, 5000);


    </script>
  </body>
</html>
